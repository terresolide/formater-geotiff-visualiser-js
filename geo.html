<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
    <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
   <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="https://openlayers.org/en/v4.4.2/build/ol.js" type="text/javascript"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
    <title>GEOTIFF</title>
  </head>
  <body>
    <h2>My Map + geotiff</h2>
    <input id="next" type="button" value="next" />
    <div id="map" class="map"></div>
    <script src="/dist/geotiff.browserify.js"></script>


<script>
  var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([-74.22655, 40.71222]),
          zoom: 11
        })
  });
      
  proj4.defs("EPSG:4267","+proj=longlat +datum=NAD27 +no_defs");
  var xhr = new XMLHttpRequest();
  xhr.open('GET',  'cea.tif', true);
  xhr.responseType = 'arraybuffer';
  xhr.onload = function(e) {
    var parser = GeoTIFF.parse(this.response);
    var image = parser.getImage();
    var projection = new ol.proj.Projection({
            code: "EPSG:" + image.getGeoKeys().GeographicTypeGeoKey
    });
    console.log(image.getFileDirectory(), image.getGeoKeys());
   
    var imageExtent = [0, 0, 700000, 1300000];
    //image.readRasters({samples: [0,1,2], interleave: true}, function(raster) {
    image.readRGB(function(raster) {
        var canvasFunction = function(extent, resolution, pixelRatio, size, projection) {
   
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            var canvasWidth = size[0], canvasHeight = size[1];
            canvas.setAttribute('width', canvasWidth);
            canvas.setAttribute('height', canvasHeight);

            var imageData = ctx.createImageData(image.getWidth()/2, image.getHeight()/2);
            var data = imageData.data;
            var o = 0;
            for (var i = 0; i < raster.length; i+=3) {
              data[o] = raster[i];
              data[o+1] = raster[i+1];
              data[o+2] = raster[i+2];
              data[o+3] = 255;
              o += 4;
            }
            ctx.putImageData(imageData, 300, 500);
            return canvas;
        }
        var canvasLayer = new ol.layer.Image({
            source: new ol.source.ImageCanvas({
                canvasFunction: canvasFunction,
                projection: 'EPSG:3857'
            })
        });
        map.addLayer(canvasLayer);
    });
  }
  xhr.send();

</script>
  </body>
</html>